---
name: Tests (Liquidsoap)
on: # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main

jobs:
  liquidsoap-fmt:
    name: liquidsoap scripts formatting (liquidsoap-prettier)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - run: 'npm install -g liquidsoap-prettier'
    - run: |
        ret=0
        for file in $(find . -type f -name "*.liq"); do
          if ! liquidsoap-prettier -c "${file}"; then
            ret=2 ; echo "${file} is not formatted"
          fi
        done
        exit $ret

  docker_test_image:
    name: Find docker test image
    runs-on: ubuntu-latest
    outputs:
      docker_test_image: ${{ steps.docker_test_image.outputs.docker_test_image }}
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: "Find docker test image"
      id: docker_test_image
      run: |
        DOCKER_TEST_IMAGE=`cat docker-compose.yml | grep -A 1 "container_name: liquidsoap-test" | grep image: | tr -s ' ' | cut -d' ' -f 3 | head -n 1`
        echo "Docker test image: ${DOCKER_TEST_IMAGE}"
        echo "docker_test_image=${DOCKER_TEST_IMAGE}" >> $GITHUB_OUTPUT

  liquidsoap-test-transcoder-stereo:
    name: liquidsoap syntax (transcoder stereo)
    runs-on: ubuntu-latest
    needs: docker_test_image
    container:
      image: ${{ needs.docker_test_image.outputs.docker_test_image }}
      options: --user root
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - run: '/usr/bin/liquidsoap -c ./example/liquidsoap/myradio.liq ./scripts/transcoder/00-live.liq'

  liquidsoap-test-transcoder-surround:
    name: liquidsoap syntax (transcoder surround)
    runs-on: ubuntu-latest
    needs: docker_test_image
    container:
      image: ${{ needs.docker_test_image.outputs.docker_test_image }}
      options: --user root
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - run: '/usr/bin/liquidsoap -c ./example/liquidsoap/myradiosurround.liq ./scripts/transcoder/00-live.liq'

  liquidsoap-test-streamer-stereo:
    name: liquidsoap syntax (streamer stereo)
    runs-on: ubuntu-latest
    needs: docker_test_image
    container:
      image: ${{ needs.docker_test_image.outputs.docker_test_image }}
      options: --user root
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - run: '/usr/bin/liquidsoap -c ./example/liquidsoap/myradio.liq ./scripts/transcoder/00-live.liq'

  liquidsoap-test-streamer-surround:
    name: liquidsoap syntax (streamer surround)
    runs-on: ubuntu-latest
    needs: docker_test_image
    container:
      image: ${{ needs.docker_test_image.outputs.docker_test_image }}
      options: --user root
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - run: '/usr/bin/liquidsoap -c ./example/liquidsoap/mystreamersurround.liq ./scripts/streamer/00-live.liq'
